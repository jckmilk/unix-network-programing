## TCP连接的建立和终止

### 三路握手

- 服务器准备好外来的连接，调用socket，bind和listen函数，称为被动打开。
- 客户调用connect函数主动打开，导致客户TCP发送一个SYN分节，它告诉服务器用户将在连接中发送的数据初始序列号。通常SYN不携带数据。
- 服务器确认SYN，同时发送字一个SYN分节，含有服务器在同一连接中发送数据的初始序列号。
- 客户确认服务器的SYN。

### TCP选项

- MSS选项。发送SYN的TCP一端通过本选项告诉对端最大分节大小，即每个TCP分节的最大数据量。
- 窗口选项。最大窗口为65535，使用窗口的前提是两端系统都支持这个选项。
- 时间戳选项

### TCP连接终止

1. 应用程序调用close函数。该端为主动关闭，该端发送一个FIN字节。
2. 接收FIN的端执行被动关闭。这个FIN将作为文件结束符传递给接收端的应用程序。
3. 一段时间后，接收到这个文件结束符的应用程序调用close关闭套接字。导致它的TCP也发送一个FIN。
4. 接收端确认这个FIN。

### TCP状态转换图
### TIME_WAIT状态

最长分节生命的两倍，被称为2MSL。

**由于路由的问题导致迷途的分组在超时重传后又到达了目的地**，必须正确处理这些分组。

Time_wait存在的两个理由
- 可靠地实现TCP全双工连接的终止；
- 允许老的重复的分组在网络中消逝。
  
第一个理由是最后一个ACK丢失了。服务器将重新发送新的FIN，因此客户必须**维护状态信息**，以允许重新发送最终的ACK。如果客户不维护状态信息，则响应RST，该分解将会被解释为错误。

第二个理由：TCP必须防止某个连接的老的重复的分组在该连接终止后再现，从而被误解为属于同一个连接的某一个新的化身。TCP将不给处于TIME_WAIT状态的连接发起新的化身，2MSL足以使某一个分组被丢弃。

### 端口号

16位 整数代表端口
定义了一组众所周知的端口号
短期存活的临时端口，这些端口由传输层自动赋予客户

- 众所周知的端口 0~1023
- 已登记的端口 1024~49151
- 动态或私有端口 49152~65535

### 缓冲区大小及其限制

